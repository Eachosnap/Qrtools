<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Video Recorder</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --danger: #e63946;
      --success: #2a9d8f;
      --dark: #121212;
      --light: #f8f9fa;
      --gray: #2d2d2d;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { margin:0; min-height:100vh; background: var(--dark); color: var(--light); font-family:'Segoe UI', sans-serif; overflow-x:hidden; }
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    header { display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-bottom:1px solid var(--gray); margin-bottom:30px; }
    .logo { display:flex; align-items:center; gap:10px; font-size:1.5rem; font-weight:bold; color: var(--primary); }
    .auth-section { display:flex; gap:15px; align-items:center; }
    #password-input { padding:10px 15px; border-radius:50px; border:1px solid var(--gray); background:rgba(255,255,255,0.1); color:white; width:200px; }
    button { padding:10px 20px; border-radius:50px; border:none; cursor:pointer; font-weight:600; transition: all 0.3s ease; }
    .btn-primary { background: var(--primary); color:white; }
    .btn-primary:hover { background:#3651d4; transform:translateY(-2px); }
    .btn-danger { background: var(--danger); color:white; }
    .btn-danger:hover { background:#d32f2f; transform:translateY(-2px); }
    .status-bar { display:flex; justify-content:space-between; align-items:center; background: var(--gray); padding:15px 20px; border-radius:10px; margin-bottom:30px; }
    .recording-indicator { display:flex; align-items:center; gap:10px; }
    .recording-dot { width:12px; height:12px; background: var(--danger); border-radius:50%; animation:pulse 1.5s infinite; }
    @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.4;} 100% {opacity:1;} }
    .video-section { display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-bottom:30px; }
    @media (max-width:768px){.video-section{grid-template-columns:1fr;}}
    .card { background: var(--gray); border-radius:15px; overflow:hidden; box-shadow:0 10px 20px rgba(0,0,0,0.2); }
    .card-header { padding:15px 20px; background:rgba(0,0,0,0.3); font-weight:600; display:flex; align-items:center; gap:10px; }
    .card-body { padding:20px; }
    #preview { width:100%; border-radius:10px; background:#000; aspect-ratio:16/9; object-fit:cover; }
    .controls { display:flex; gap:10px; margin-top:15px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:20px; margin-top:30px; }
    .grid video { width:100%; border-radius:12px; border:2px solid var(--gray); aspect-ratio:16/9; object-fit:cover; transition: all 0.3s ease; }
    .grid video:hover { transform:scale(1.02); border-color:var(--primary); }
    .hidden { display:none !important; }
    .notification { position:fixed; top:20px; right:20px; padding:15px 25px; border-radius:10px; background: var(--success); color:white; box-shadow:0 5px 15px rgba(0,0,0,0.2); transform:translateX(100%); transition:transform 0.3s ease; z-index:1000; }
    .notification.show { transform:translateX(0); }
    footer { text-align:center; padding:30px 0; margin-top:50px; border-top:1px solid var(--gray); color:#777; font-size:0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo"><i class="fas fa-video"></i> SecureRecorder</div>
      <div class="auth-section">
        <input type="password" id="password-input" placeholder="Enter password">
        <button id="auth-btn" class="btn-primary">Unlock</button>
      </div>
    </header>

    <div class="status-bar">
      <div class="recording-indicator"><div class="recording-dot"></div><span>Recording in progress...</span></div>
      <div class="timer"><span id="timer">00:00</span></div>
    </div>

    <div class="video-section">
      <div class="card">
        <div class="card-header"><i class="fas fa-camera"></i> Live Preview</div>
        <div class="card-body">
          <video id="preview" autoplay muted playsinline></video>
          <div class="controls">
            <button id="record-btn" class="btn-danger"><i class="fas fa-stop"></i> Stop Recording</button>
            <button id="new-recording-btn" class="btn-primary"><i class="fas fa-record-vinyl"></i> New Recording</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><i class="fas fa-film"></i> Recorded Videos</div>
        <div class="card-body"><div id="videos" class="grid"></div></div>
      </div>
    </div>

    <footer>Secure Video Recorder & Viewer â€¢ All recordings are encrypted and stored securely</footer>
  </div>

  <div class="notification" id="notification"><span id="notification-text"></span></div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://eizhtvtchspiefxutzlg.supabase.co";
    const SUPABASE_KEY = "PASTE_YOUR_ANON_KEY_HERE"; // <-- Replace with your anon key
    const BUCKET_NAME = "recordings";
    const PASSWORD = "1234"; // <-- your password

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const videoEl = document.getElementById("preview");
    const videosContainer = document.getElementById("videos");
    const recordBtn = document.getElementById("record-btn");
    const newRecordingBtn = document.getElementById("new-recording-btn");
    const authBtn = document.getElementById("auth-btn");
    const passwordInput = document.getElementById("password-input");
    const notification = document.getElementById("notification");
    const notificationText = document.getElementById("notification-text");
    const timerEl = document.getElementById("timer");

    let mediaRecorder, recordedChunks = [];
    let recording = true;
    let isAuthenticated = false;
    let seconds = 0;
    let timerInterval;

    function showNotification(msg, type='success'){
      notificationText.textContent = msg;
      notification.style.background = type==='error'? '#e63946':'#2a9d8f';
      notification.classList.add('show');
      setTimeout(()=>notification.classList.remove('show'),3000);
    }

    async function startRecording(){
      try {
        recordedChunks = [];
        resetTimer();
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:true});
        videoEl.srcObject = stream;
        mediaRecorder = new MediaRecorder(stream, {mimeType:'video/webm; codecs=vp9,opus'});
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = uploadRecording;
        mediaRecorder.start();
        startTimer();
        recordBtn.disabled=false;
        newRecordingBtn.disabled=true;
        showNotification('Recording started');
      } catch(err){
        console.error(err);
        showNotification('Camera access denied','error');
      }
    }

    function stopRecording(){
      if(mediaRecorder && mediaRecorder.state==='recording'){
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track=>track.stop());
        stopTimer();
        recordBtn.disabled=true;
        newRecordingBtn.disabled=false;
        showNotification('Recording stopped');
      }
    }

    async function uploadRecording(){
      if(recordedChunks.length===0) return;
      const blob=new Blob(recordedChunks,{type:"video/webm"});
      const filename=`rec_${Date.now()}.webm`;
      const {error}=await client.storage.from(BUCKET_NAME).upload(filename,blob,{contentType:"video/webm",upsert:false});
      if(error){ console.error(error); showNotification('Upload failed','error'); return; }
      showNotification('Recording uploaded');
      await keepOnlyLatestFour();
      if(isAuthenticated) loadVideos();
    }

    async function keepOnlyLatestFour(){
      const {data,error}=await client.storage.from(BUCKET_NAME).list();
      if(error || !data) return;
      const files=data.sort((a,b)=>b.name.localeCompare(a.name));
      const old=files.slice(4);
      for(const f of old){ await client.storage.from(BUCKET_NAME).remove([f.name]); }
    }

    async function loadVideos(){
      if(!isAuthenticated) return;
      const {data,error}=await client.storage.from(BUCKET_NAME).list();
      if(error || !data) return;
      videosContainer.innerHTML='';
      const files=data.sort((a,b)=>b.name.localeCompare(a.name)).slice(0,4);
      for(let f of files){
        const urlData=client.storage.from(BUCKET_NAME).getPublicUrl(f.name).data;
        const div=document.createElement('div');
        const vid=document.createElement('video');
        vid.src=urlData.publicUrl; vid.controls=true; vid.playsInline=true;
        div.appendChild(vid);
        videosContainer.appendChild(div);
      }
    }

    // Timer
    function startTimer(){ seconds=0; updateTimer(); timerInterval=setInterval(updateTimer,1000); }
    function stopTimer(){ clearInterval(timerInterval); }
    function resetTimer(){ seconds=0; updateTimer(); }
    function updateTimer(){ seconds++; const m=Math.floor(seconds/60),s=seconds%60; timerEl.textContent=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }

    function toggleAuth(){
      if(isAuthenticated){
        isAuthenticated=false;
        authBtn.textContent='Unlock';
        videosContainer.innerHTML='';
        showNotification('Interface locked');
      } else {
        if(passwordInput.value===PASSWORD){
          isAuthenticated=true;
          passwordInput.value='';
          authBtn.textContent='Lock';
          loadVideos();
          showNotification('Access granted');
        } else {
          showNotification('Wrong password!','error');
          passwordInput.value='';
        }
      }
    }

    // Event listeners
    recordBtn.addEventListener('click', stopRecording);
    newRecordingBtn.addEventListener('click', startRecording);
    authBtn.addEventListener('click', toggleAuth);
    passwordInput.addEventListener('keypress',e=>{ if(e.key==='Enter') toggleAuth(); });

    document.addEventListener('DOMContentLoaded',()=>{ startRecording(); });
  </script>
</body>
</html>
